import os
import telegram
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
import requests

# --- –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–æ–º–∞–Ω–¥ ---

def start(update, context):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î –≤—ñ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏ –∫–æ–º–∞–Ω–¥—ñ /start."""
    welcome_text = (
        "–í—ñ—Ç–∞—é! –Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –∫—Ä–∏–ø—Ç–æ-—Ç—Ä–µ–π–¥–µ—Ä –±–æ—Ç. "
        "–Ø –¥–æ–ø–æ–º–æ–∂—É –≤–∞–º –±—É—Ç–∏ –≤ –∫—É—Ä—Å—ñ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –Ω–æ–≤–∏–Ω —Ç–∞ —Ä–∏–Ω–∫–æ–≤–∏—Ö —Ç–µ–Ω–¥–µ–Ω—Ü—ñ–π.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:\n"
        "/news - –û—Ç—Ä–∏–º–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ –Ω–æ–≤–∏–Ω–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç.\n"
        "/price <–°–ò–ú–í–û–õ> - –î—ñ–∑–Ω–∞—Ç–∏—Å—å —Ü—ñ–Ω—É (–Ω–∞–ø—Ä. /price BTC).\n"
        "/digest - –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç —Ä–∏–Ω–∫—É.\n"
    )
    update.message.reply_text(welcome_text)

def get_news(update, context):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î –¥–æ–±—ñ—Ä–∫—É –Ω–æ–≤–∏–Ω."""
    # –£ —Ä–µ–∞–ª—å–Ω–æ–º—É –±–æ—Ç—ñ —Ç—É—Ç –±—É–¥–µ –∫–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É –Ω–æ–≤–∏–Ω –∑ —Å–∞–π—Ç—ñ–≤ –∞–±–æ —á–µ—Ä–µ–∑ API
    # –ó–∞—Ä–∞–∑ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ
    news_headlines = [
        "üìà *–ê–Ω–∞–ª—ñ–∑ —Ü—ñ–Ω:* –ë–∏–∫–∏ BTC –≥–æ—Ç—É—é—Ç—å—Å—è –¥–æ —Ä–∏–≤–∫–∞ –≤–∏—â–µ $85,000, —â–æ –º–æ–∂–µ –ø–æ—Ç—è–≥–Ω—É—Ç–∏ –∑–∞ —Å–æ–±–æ—é –∞–ª—å—Ç–∫–æ—ó–Ω–∏.",
        "üìâ *–ö–æ—Ä–µ–∫—Ü—ñ—è —Ä–∏–Ω–∫—É:* –ê–Ω–∞–ª—ñ—Ç–∏–∫–∏ –≤–≤–∞–∂–∞—é—Ç—å –ø–æ—Ç–æ—á–Ω–µ –ø–∞–¥—ñ–Ω–Ω—è —Ü—ñ–Ω–∏ Bitcoin —Ç–∏–º—á–∞—Å–æ–≤–∏–º '—Å—Ç—Ä—É—Å–æ–º' –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –µ—Ç–∞–ø–æ–º –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è.",
        "üá™üá∫ *–†–µ–≥—É–ª—è—Ü—ñ—è:* –Ñ–° –ø—Ä–æ–¥–æ–≤–∂—É—î –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø—Ä–∞–≤–∏–ª –¥–ª—è –∫—Ä–∏–ø—Ç–æ-–∫–æ–º–ø–∞–Ω—ñ–π, —â–æ –º–æ–∂–µ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ —Ä–∏–Ω–æ–∫ –≤ —Å–µ—Ä–µ–¥–Ω—å–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ñ.",
        "üí∞ *–Ü–Ω—Å—Ç–∏—Ç—É—Ü—ñ–æ–Ω–∞–ª–∏:* Goldman Sachs —Ç—Ä–∏–º–∞—î –ø–æ–Ω–∞–¥ $400 –º–ª–Ω —É –±—ñ—Ç–∫–æ—ó–Ω-ETF, —â–æ —Å–≤—ñ–¥—á–∏—Ç—å –ø—Ä–æ –∑—Ä–æ—Å—Ç–∞—é—á—É –¥–æ–≤—ñ—Ä—É –≤–µ–ª–∏–∫–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤."
    ]
    update.message.reply_text("üì∞ *–û—Å—Ç–∞–Ω–Ω—ñ –Ω–æ–≤–∏–Ω–∏ —Ä–∏–Ω–∫—É:*\n\n" + "\n\n".join(news_headlines), parse_mode=telegram.ParseMode.MARKDOWN)

def get_price(update, context):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ü—ñ–Ω—É –¥–ª—è –≤–∫–∞–∑–∞–Ω–æ—ó –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏."""
    try:
        symbol = context.args[0].upper()
        # –£ —Ä–µ–∞–ª—å–Ω–æ–º—É –±–æ—Ç—ñ —Ç—É—Ç –±—É–¥–µ –∑–∞–ø–∏—Ç –¥–æ API (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, CoinGecko, Binance)
        # –Ü–º—ñ—Ç—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å API
        if symbol == 'BTC':
            price = "61,543.21"
            change = "+1.25%"
        elif symbol == 'ETH':
            price = "2,015.89"
            change = "-0.5%"
        else:
            update.message.reply_text(f"–í–∏–±–∞—á—Ç–µ, —è –ø–æ–∫–∏ –Ω–µ –≤—ñ–¥—Å—Ç–µ–∂—É—é {symbol}.")
            return

        message = f"–¶—ñ–Ω–∞ –¥–ª—è *{symbol}*:\n\n*–¶—ñ–Ω–∞:* ${price}\n*–ó–º—ñ–Ω–∞ –∑–∞ 24–≥:* {change}"
        update.message.reply_text(message, parse_mode=telegram.ParseMode.MARKDOWN)

    except (IndexError, ValueError):
        update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å —Å–∏–º–≤–æ–ª –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏ –ø—ñ—Å–ª—è –∫–æ–º–∞–Ω–¥–∏. \n*–ü—Ä–∏–∫–ª–∞–¥:* /price BTC", parse_mode=telegram.ParseMode.MARKDOWN)

def get_digest(update, context):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ—Ä–æ—Ç–∫–∏–π –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç."""
    digest_text = (
        "üìä *–©–æ–¥–µ–Ω–Ω–∏–π –¥–∞–π–¥–∂–µ—Å—Ç —Ä–∏–Ω–∫—É:*\n\n"
        "–†–∏–Ω–æ–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –æ–∑–Ω–∞–∫–∏ –∫–æ–Ω—Å–æ–ª—ñ–¥–∞—Ü—ñ—ó –ø—ñ—Å–ª—è –Ω–µ–¥–∞–≤–Ω—å–æ—ó –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—ñ. Bitcoin —É—Ç—Ä–∏–º—É—î –∫–ª—é—á–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å –ø—ñ–¥—Ç—Ä–∏–º–∫–∏, —â–æ —î –ø–æ–∑–∏—Ç–∏–≤–Ω–∏–º —Å–∏–≥–Ω–∞–ª–æ–º. "
        "–£–≤–∞–≥–∞ —ñ–Ω–≤–µ—Å—Ç–æ—Ä—ñ–≤ –ø—Ä–∏–∫—É—Ç–∞ –¥–æ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ –∑–∞—Å—ñ–¥–∞–Ω–Ω—è –§–†–°, —Ä—ñ—à–µ–Ω–Ω—è —è–∫–æ–≥–æ –º–æ–∂–µ —Å—É—Ç—Ç—î–≤–æ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ —Ü—ñ–Ω—É. "
        "–ê–ª—å—Ç–∫–æ—ó–Ω–∏ —Å–ª—ñ–¥—É—é—Ç—å –∑–∞ –¥–∏–Ω–∞–º—ñ–∫–æ—é BTC, –∞–ª–µ –¥–µ—è–∫—ñ –ø—Ä–æ—î–∫—Ç–∏ –≤ —Å–µ–∫—Ç–æ—Ä—ñ GameFi, —è–∫-–æ—Ç TON, –ø–æ–∫–∞–∑—É—é—Ç—å –Ω–µ–∑–∞–ª–µ–∂–Ω–µ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è –Ω–∞ —Ç–ª—ñ –ø–æ–∑–∏—Ç–∏–≤–Ω–∏—Ö –Ω–æ–≤–∏–Ω."
    )
    update.message.reply_text(digest_text, parse_mode=telegram.ParseMode.MARKDOWN)

def unknown(update, context):
    """–û–±—Ä–æ–±–∫–∞ –Ω–µ–≤—ñ–¥–æ–º–∏—Ö –∫–æ–º–∞–Ω–¥."""
    update.message.reply_text("–í–∏–±–∞—á—Ç–µ, —è –Ω–µ –∑—Ä–æ–∑—É–º—ñ–≤ —Ü—é –∫–æ–º–∞–Ω–¥—É. –°–ø—Ä–æ–±—É–π—Ç–µ /start, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–æ–º–∞–Ω–¥.")

# --- –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ –±–æ—Ç–∞ ---

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞."""
    # –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—É –∑ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö –¥–ª—è –±–µ–∑–ø–µ–∫–∏
    token = os.environ.get('TELEGRAM_TOKEN')
    if not token:
        print("–ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ TELEGRAM_TOKEN. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤–∏ –π–æ–≥–æ –¥–æ–¥–∞–ª–∏.")
        return

    updater = Updater(token, use_context=True)
    dp = updater.dispatcher

    # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –∫–æ–º–∞–Ω–¥
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("news", get_news))
    dp.add_handler(CommandHandler("price", get_price))
    dp.add_handler(CommandHandler("digest", get_digest))

    # –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –Ω–µ–≤—ñ–¥–æ–º–∏—Ö –∫–æ–º–∞–Ω–¥
    dp.add_handler(MessageHandler(Filters.command, unknown))

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    updater.start_polling()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ...")
    updater.idle()

if __name__ == '__main__':
    main()
